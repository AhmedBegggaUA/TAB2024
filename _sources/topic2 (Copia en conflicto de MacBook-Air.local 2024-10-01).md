# Graph Matching 

## Maximum Common Subgraph

**Motivation**. Chemical compounds exhibit structural patters shared between compounds of the same family. One of these patterns is the circular (hexagonal) structure formed by carbon (C) atoms linked by single or double bonds (see {numref}`Aspirin`-Left and Center) where the non-labeled vertices denote C atoms. In this example, the presence of the hexagonal ring in the popular [Aspirin](https://pubchem.ncbi.nlm.nih.gov/compound/Aspirin) ({numref}`Aspirin`-Right) is well known. 

The development of AI pattern matching techniques for detetecting substructures has powered the field of Bioinformatics. Nowadays, the analysis of exponentially growing datasets of proteins such as the Protein Data Bank [PDB](https://www.wwpdb.org/) or of chemical compounds such as [PubChem](https://pubchem.ncbi.nlm.nih.gov/) is a must in AI. 

```{figure} ./images/Topic2/MCS-Aspirin-Photoroom.png
---
name: Aspirin
width: 800px
align: center
height: 300px
---
Structure of the Aspirin.
```

**MCS**. Comparing substructures is not an easy problem. Whereas comparing substrings is polynomial, comparing substrutures is a well-known NP problem called the <span style="color:#f88146">Maximum Common Subgraph</span> or MCS: 

*Given two graphs $G_1=(V_1,E_1)$  and $G_2=(V_2,E_2)$, what is the graph $H=(V,E)$ that is *common* to $G_1$ and $G_2$ with the maximum number of nodes*?

Herein, *common* means the following: $V = V\subseteq V_1$ and $E\subseteq E_1$ and exists an injective (one-to-one) mapping $f:V\rightarrow V_2$ such that $(i,j)\in E$ iff $(f(i),f(j))\in E_2$. 

This <span style="color:#f88146">**subsetness flavor**</span> clarifies the fact that <span style="color:#f88146">$\text{MCS}\in \text{NP}$</span>. Actually, MCS does not only search for one common subset but for *the subset with the maximum number of nodes*. 

This is quite clear in the following *Breaking Bad* problem: <span style="color:#f88146">What is the structural coincidence between Ectasy and Amphetamine?</span>. 
- According to PubChem, [Ectasy](https://pubchem.ncbi.nlm.nih.gov/compound/3_4-Methylenedioxymethamphetamine) is derived from the [Amphetamine](https://pubchem.ncbi.nlm.nih.gov/compound/Amphetamine).
- Looking at {numref}`Drugs`-Center (Ectasy)
comes from removing an Hidrogen atom from Amphetamine ({numref}`Drugs`-Right), adding a carbon and an oxigen-carbon pentagonal cycle. 
- The MCS is in {numref}`Drugs`-Left.

```{figure} ./images/Topic2/Drugs-Photoroom.png
---
name: Drugs
width: 800px
align: center
height: 200px
---
Maximal Common Substructure (left) of two design drugs (center and right).
```

All the figures have been generated by the [RDKit: Open-Source Cheminformatics Software](https://www.rdkit.org/). 


## SoftAssign
Solving MCS via a polynomial approximation requires *finding the injective function* $f$ between the vertices $V$ of small graph $X=(V,E)$ and those $V'$ of larger graph $Y=(V',E')$ in polynomial time. 

### Assignments and Matchings

**Node assignments**. Consider the (undirected) graphs: 

$$
\begin{aligned}
&\begin{array}{cll}
\text{Graph}  & \text{Nodes} & \text{Edges}\\
X & V=\{a,b,c\} & E=\{(a,b),(b,c)\}\\
Y & V'=\{1,2,3,4,5\} & E=\{(1,2),(1,3),(1,4),(3,4)\}\\
\end{array}
\end{aligned}
$$

As we have $n=|V'|=5$ and $r=|V|=3$ we have $P(n,r)=n\cdot (n-1)\cdot (n-r + 1)$ **r-permutations** i.e. one-to-one functions $f$ or <span style="color:#f88146">**node assignments**</span> that can be potential solutions to the MCS problem. In this case, we have $P(5,3)=5\cdot 4\cdot 3=60$ different  assignments. Then, <span style="color:#f88146">what assignments provide the MCS between $X$ and $Y$</span>? 

For the graphs $X$ and $Y$ the size of the MCS is $2$, since $X$ has only two edges and if it is a subgraph of $Y$ (as it is really is), the size of the MCS has $|V|=3$ nodes and |E|=2$ edges. 

However, this depends on how good is the injective function $f$. For the one in {numref}`Matching` we have: 

$$
f(a)=1,\; f(b)=2\;\text{and}\; f(c)=3\;.
$$

As we can see, $(a,b)\in E$ and $(1=f(a),2=f(b))\in E'$. However, for the other edge $(b,c)\in E$ we have that $(2=f(b),3=f(c))\not\in E'$: As a result $X$ and $Y$ <span style="color:#f88146">**do only have one common edge for $f$**</span> (in magenta). 


```{figure} ./images/Topic2/Matching1-Photoroom.png
---
name: Matching
width: 600px
align: center
height: 400px
---
non-Maximal Common Substructure.
```

Consider now the assignment: 

$$
f(a)=1,\; f(b)=4\;\text{and}\; f(c)=5\;.
$$

which indeed leads to a MCS: 

```{figure} ./images/Topic2/Matching2-Photoroom.png
---
name: Matching2
width: 600px
align: center
height: 400px
---
A Maximal Common Substructure.
```
However, this MCS assignment **is not unique**. Actually we have ${5 \choose 3}=10$ subgraphs of $Y$ where we can *embed* $X$ but only $8$ of them lead to MCS assignments. In the above table, we encode each MCS injective function $f_i$ as a list of <span style="color:#f88146"> **pairwise matchings** $(v\in V, f_i(v)\in V')$</span>: 

$$
\begin{aligned}
&\begin{array}{cl}
\text{Injection} & \text{MCS Assignment} \\
f_1 & [(a, 1), \mathbf{(b, 4)}, (c, 5)]\\
f_2 & [(a, 2), \mathbf{(b, 1)}, (c, 3)]\\
f_3 & [(a, 2), \mathbf{(b, 1)}, (c, 4)]\\
f_4 & [(a, 3), \mathbf{(b, 1)}, (c, 2)]\\
f_5 & [(a, 3), \mathbf{(b, 1)}, (c, 4)]\\
f_6 & [(a, 4), \mathbf{(b, 1)}, (c, 2)]\\
f_7 & [(a, 4), \mathbf{(b, 1)}, (c, 3)]\\
f_8 & [(a, 5), \mathbf{(b, 4)}, (c, 1)]\\
\end{array}
\end{aligned}
$$

**Notable vertices**. In the above table, note that MCS assignments usually contain pairwise matchings between nodes with large degrees (notable vertices) in both graphs, namely $\mathbf{b}$ and $\mathbf{1}$ or $\mathbf{4}$ (in bold). These matchings are $\mathbf{(b,1)}$ and $\mathbf{(b,4)}$.

In the following exercise we emphasize the link between the subgraphs of $Y$ and the MCS assignments, which is a fundamental concept in this topic. 
<br></br>
<span style="color:#d94f0b"> 
**Exercise**. Identify the ${5 \choose 3}=10$ subgraphs of size $3$ in $Y$ (indicating both nodes and edges) and:\
**a)** Detect the ones which do correspond to a complete  embedding of $X$ in $Y$.**b)** Identify these subgraphs in the $8$ MCS assigmnets of the above table. 
<br></br>
**NOTE**. Express always the edges in **lexicographical order** i.e. $(i,j)$ if $i<j$. 
<br></br>
Answer. **a)** The subgraphs are the $10$ combinations of the $5$ nodes $V'=\{1,2,3,4,5\}$ in groups of $3$ nodes (because $|V|=3$). However, only those subgraphs wich are connected can lead to a complete embeddding of $X$ in $Y$: 
</span>
<br></br>
<span style="color:#d94f0b"> 
$
\begin{aligned}
&\begin{array}{cclc}
\text{Subgraph} & \text{Nodes} & \text{Edges} & \text{is Connected?}\\
s_1    & V_1'=(1, 2, 3) & E_1'=\{(1,2),(1,3)\} & \checkmark \\
s_2    & V_2'=(1, 2, 4) & E_2'=\{(1,2),(1,3)\} & \checkmark \\
s_3    & V_3'=(1, 2, 5) & E_3'=\{(1,2)\}&\\
s_4    & V_4'=(1, 3, 4) & E_4'=\{(1,3),(1,4)\}& \checkmark\\
s_5    & V_5'=(1, 3, 5) & E_5'=\{(1,3)\}&\\
s_6    & V_6'=(1, 4, 5) & E_6'=\{(1,4),(1,5)\}& \checkmark\\
s_7    & V_7'=(2, 3, 4) & E_7'=\emptyset &\\
s_8    & V_8'=(2, 3, 5) & E_8'=\emptyset &\\
s_9    & V_9'=(2, 4, 5) & E_9'=\{(4,5)\} &\\
s_{10} & V_{10}'=(3, 4, 5) & E_{10}'=\{(4,5)\} &\\
\end{array}
\end{aligned}
$
</span>
<br></br>
<span style="color:#d94f0b">
**b)** We have that only subgraphs $s_1$, $s_2$, $s_4$ and  $s_6$ can accomodate the full graph $X$. In graph theory we say that these subgraphs are **isomorphic** to $Y$. Note that each of these subgraphs leads to $2$ MCS assignments in the injection table above: 
</span>
<br></br>
<span style="color:#d94f0b">
$
\begin{aligned}
V_1'&=(1,2,3)\rightarrow f_2=[(a,2),(b,1),(c,3)],\; f_4=[(a,3),(b,1),(c,2)]\\
V_2'&=(1,2,4)\rightarrow f_3=[(a,2),(b,1),(c,4)],\; f_6=[(a,4),(b,1),(c,2)]\\
V_4'&=(1,3,4)\rightarrow f_5=[(a,3),(b,1),(c,4)],\; f_7=[(a,4),(b,1),(c,3)]\\
V_6'&=(1,4,5)\rightarrow f_1=[(a,1),(b,4),(c,5)],\; f_5=[(a,5),(b,4),(c,1)]\\
\end{aligned}
$
</span>
<br></br>

### Rectangle rule: Cost Function 
So far, solving MCS revolves around the idea of <span style="color:#f88146">**maximizing the number of pairwise matchings**</span> between graphs $X$ and $Y$. 

For a human, is quite clear to adopt a *greedy strategy*:
1. Identify notable vertices in $V$ and $V'$.
2. For each matching pair between notable nodes: 
  - Extend the matching pairs to neighbors.
  - Increment the number of rectables accordingly. 

Machines need a more precise specification. Maximizing the number of rectangles, however, arises from the following procedure: 

*Given $a\in V$ and $i\in V'$, a rectangle appears if:* 
 1. *We match $a$ and $i$*
 2. *We match $b$ and $j$, which are respective neighbors of $a$ and $i$: $b\in {\cal N}_a$ and $j\in {\cal N}_i$.*

 In other words, a rectangle happens when we match two nodes and their respective neighbors do also match. This is exacly why we prefer pairwise matchings between notable vertices: because they are more likely to produce more rectangles. 

 This rationale leads to the <span style="color:#f88146">**second-order flavor**</span> of MCS, also known as <span style="color:#f88146">**Graph Matching**</span> inside the Pattern Recognition community. Indeed, posing the problem in matricial terms, we have:
 - The adjacency matrices $\mathbf{X}\in\{0,1\}^{m\times m}$ and $\mathbf{Y}\in\{0,1\}^{n\times n}$ of graphs $X$ and $Y$.
 - The unknown <span style="color:#f88146">**matching matrix**</span> $\mathbf{M}\in\{0,1\}^{n\times m}$, where $\mathbf{M}_{ia}=1$ means that $i\in V$ matches $a\in V'$.

Therefore, a rectagle exists if *its four sides do exist*, i.e. if

$$
\exists a,b\in V, \exists i,j\in V':\; \mathbf{M}_{ai}\mathbf{M}_{bj}\mathbf{X}_{ab}\mathbf{Y}_{ij}>0\;,
$$

where $\mathbf{X}_{ab}$ and $\mathbf{Y}_{ij}$ encode the respective neighboring rules (sides of the rectangle) as we show in {numref}`Rectangle`. 


```{figure} ./images/Topic2/Rectangle-Photoroom.png
---
name: Rectangle
width: 600px
align: center
height: 400px
---
The Rectangle Rule in Graph Matching.
```

**Quadratic Cost function**. A function that counts the number of rectangles given by a matching matrix $\mathbf{M}$ is simply: 

$$
F(\mathbf{M}) = \frac{1}{2}\sum_{a\in V}\sum_{i\in V'}\sum_{b\in V}\sum_{j\in V'}\mathbf{M}_{ai}\mathbf{M}_{bj}\mathbf{X}_{ab}\mathbf{Y}_{ij}\;,
$$

where $1/2$ factor removes rectangles counted twice. 

Consider for instance the graphs in {numref}`Rectangle`. They are directed (i.e. *digraphs*). Let us found the MCS using the matricial formulation and the above function. 

$$
\begin{align}
\mathbf{X} = 
\begin{array}{l}
a\\
b\\
c\\
d\\
\end{array}
\begin{bmatrix}
0 & 1 & 1 & 1 & 1\\
0 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0\\
\end{bmatrix}
\;\; 
\mathbf{Y} = 
\begin{array}{l}
i\\
j\\
k\\
l\\
\end{array}
\begin{bmatrix}
0 & 1 & 1 & 1 & 1\\
0 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0\\
0 & 0 & 0 & 0 & 0\\
\end{bmatrix}
\end{align}
$$

The matching in {numref}`Rectangle` is given by 




